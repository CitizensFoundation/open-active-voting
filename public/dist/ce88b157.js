import{b as e,d as t,h as o,_ as i,p as r,c as a}from"./0148e6d4.js";import"./e636a7c2.js";import"./09fab2e1.js";let s;const p=e(s||(s=(e=>e)`paper-dialog{padding-left:8px;padding-right:8px;width:440px;background-color:#fff}paper-dialog{z-index:9999}@media (max-width:480px){paper-dialog{padding:0;margin:0;height:100%;width:100%}}paper-spinner{padding:0;margin:0}.buttons{margin-left:0;padding-left:0;color:var(--app-accent-color);font-size:18px;padding-top:8px}.checkBox{margin-top:16px}paper-input{--paper-input-container-focus-color:var(--app-accent-color)}paper-checkbox{--paper-checkbox-checked-color:var(--app-accent-color);padding-top:8px}.postcodeWrongWard{color:var(--paper-red-a400)}`));let n,d,c,l=e=>e,h=class extends t{constructor(){super(),this.userSpinner=!1,this.confirmedAge=!1,this.emailValidationPattern="^[_A-Za-z0-9-\\+]+(\\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\\.[A-Za-z0-9]+)*(\\.[A-Za-z]{2,})$",this.postCodes={},this.postCodesAreas={},this.postCodesAreasNames={},this.opened=!1,this.confirmedAge=!1}static get styles(){return[p]}render(){return o(n||(n=l` <paper-dialog id="dialog" with-backdrop> <div class="layout horizontal center-center"> <h2>${0}</h2> </div> <form is="iron-form" id="form"> <paper-input id="email" type="text" label="${0}" .value="${0}" minlength="5" .error-message="${0}"> </paper-input> <paper-input id="postCode" type="text" label="${0}" .value="${0}" maxlength="${0}"> </paper-input> <div class="postcodeWrongWard" ?hidden="${0}"> ${0} ${0}.<br><br> ${0} <a href="/area-ballot/${0}" @click="${0}">${0}</a> ${0} ${0}. </div> ${0} </form> <div class="buttons layout vertical"> <paper-button autofocus @tap="${0}">${0}</paper-button> </div> </paper-dialog> `),this.localize("loginWithEmailAndPostCode"),this.localize("userEmail"),this.email,this.emailErrorMessage,this.localize("postCode"),this.postCode,this.configFromServer.client_config.insecureEmailPostcodeMaxLength,!this.correctAreaId,this.localize("thisPostCodeDoesNotBelongTo"),this.areaName,this.localize("forThisCodeYouCanVoteHere"),this.correctAreaId,this._resetCorrectArea,this.correctAreaName,this.localize("orEnterApostCodeThatBelongsTo"),this.areaName,this.configFromServer.client_config.insecureEmailAgeLimit?o(d||(d=l` <paper-checkbox id="confirmedAge" class="checkBox" name="confirmedAge"> ${0} </paper-checkbox> `),this.localize("confirmAge")):o(c||(c=l``)),this._validateAndSend,this.localize("authenticateAndVote"))}firstUpdated(e){super.firstUpdated(e),Object.entries(this.configFromServer.client_config.insecureEmailLoginPostCodes).forEach((e=>{let t=parseInt(e[0]);e[1].forEach((e=>{this.postCodesAreas[e]=t,this.postCodesAreasNames[e]=this.configFromServer.client_config.insecureEmailLoginAreaNames[t]}))}))}_resetCorrectArea(){setTimeout((()=>{this.correctAreaId=void 0,this.correctAreaName=void 0,this.close()}),100)}_loginCompleted(){this.onLoginFunction(),this.close()}isValidPostcode(e,t){return t=t.replace(/\s/g,"").toUpperCase(),this.configFromServer.client_config.insecureEmailLoginPostCodes[e].indexOf(t)>-1}getAreaForPostCode(e){return e=e.replace(/\s/g,"").toUpperCase(),this.postCodesAreas[e]&&this.postCodesAreasNames[e]?{id:this.postCodesAreas[e],name:this.postCodesAreasNames[e]}:null}open(e,t,o){this.onLoginFunction=o,this.areaId=e,this.areaName=t,this.userSpinner=!1,this.opened=!1,this.postCode="",this.confirmedAge=!1,this.email="",this.$$("#dialog").open()}_validateAndSend(e){if(this.email=this.$$("#email").value,this.postCode=this.$$("#postCode").value,!(this.email&&this.postCode&&this.$$("#confirmedAge").checked))return this.fire("oav-error",this.localize("completeForm")),!1;if(new RegExp(this.emailValidationPattern).test(this.email)){if(this.isValidPostcode(this.areaId,this.postCode))return fetch("/votes/insecure_email_login",{method:"POST",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({insecure_email:this.email.toLowerCase(),postCode:this.postCode})}).then((e=>e.json())).then((e=>{e&&!0===e.ok?this._loginCompleted():this.fire("oav-error",this.localize("error_not_authorized"))})).catch((()=>{this.fire("oav-error",this.localize("general_error"))})),!0;if(this.getAreaForPostCode(this.postCode)){var t=this.getAreaForPostCode(this.postCode);this.correctAreaId=t.id,this.correctAreaName=t.name}else this.fire("oav-error",this.localize("enterValidPostcode"))}else this.fire("oav-error",this.localize("enterValidEmail"))}close(){var e=this.$$("#dialog");e&&e.close(),this.opened=!1,this.userSpinner=!1}};i([r({type:Object})],h.prototype,"configFromServer",void 0),i([r({type:Number})],h.prototype,"correctAreaId",void 0),i([r({type:String})],h.prototype,"areaName",void 0),i([r({type:String})],h.prototype,"correctAreaName",void 0),i([r({type:String})],h.prototype,"postCode",void 0),i([r({type:Boolean})],h.prototype,"userSpinner",void 0),i([r({type:Boolean})],h.prototype,"confirmedAge",void 0),i([r({type:String})],h.prototype,"postCodeValidationPattern",void 0),i([r({type:String})],h.prototype,"emailValidationPattern",void 0),i([r({type:String})],h.prototype,"emailErrorMessage",void 0),i([r({type:String})],h.prototype,"passwordErrorMessage",void 0),i([r({type:String})],h.prototype,"name",void 0),i([r({type:String})],h.prototype,"email",void 0),i([r({type:String})],h.prototype,"submitText",void 0),i([r({type:Object})],h.prototype,"onLoginFunction",void 0),i([r({type:Number})],h.prototype,"areaId",void 0),i([r({type:Object})],h.prototype,"postCodes",void 0),i([r({type:Object})],h.prototype,"postCodesAreas",void 0),i([r({type:Object})],h.prototype,"postCodesAreasNames",void 0),i([r({type:Boolean})],h.prototype,"opened",void 0),h=i([a("oav-insecure-email-login")],h);export{h as OavInsecureEmailLogin};
