<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../oav-ajax/oav-ajax.html">

<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<dom-module id="oav-area-budget">
  <style include="iron-flex iron-flex-alignment">

    :host {
      width: 100%;
    }

    .budgetContainer {
      height: 150px;
      width: 100%;
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      background-image: url("https://yrpri6-production.s3.amazonaws.com/cZ/xw/CF-large.png");
    }

    .budgetContainer[wide] {
      height: 300px;
      width: 100%;
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      background-image: url("https://yrpri6-production.s3.amazonaws.com/cZ/xw/CF-large.png");
    }

    .budgetMaterial {
      width: 300px;
      background-color: #fff;
      height: 180px;
      margin: 5px 0px;
      @apply(--layout-vertical);
    }

    .budgetMaterial[wide] {
      width: 960px;
      height: 228px;
      margin: 10px 0px;
      @apply(--layout-vertical);
    }

    #votes {
      width: 300px;
      background-color: var(--paper-green-100);
      height: 51px;
      @apply(--layout-horizontal);
    }

    #votes[wide] {
      width: 960px;
      height: 102px;
    }

    .budgetRuler {
      background-color: var(--paper-green-700);
      color: #FFF;
      font-size: 12px;
      padding: 4px;
      padding-right: 8x;
      padding-left: 8px;
    }

    .budgetRuler[wide] {
      font-size: 18px;
      padding: 8px;
      padding-right: 16px;
      padding-left: 16px;
    }

    .budgetHeader {
      background-color: var(--paper-green-800);
      color: #FFF;
      font-size: 26px;
      padding: 12px;
    }

    .info {
      background-color: var(--paper-green-700);
      padding: 4px;
      font-size: 12px;
    }

    .info[wide] {
      padding: 8px;
      font-size: 19px;
    }

    paper-button.voteButton {
      background-color: var(--paper-yellow-a400);
      color: #333;
      margin: 8px;
      margin-right: 4px;
    }

    paper-button[disabled] {
      background-color: #bbb;
    }

    .selectedInfo {
      padding-top: 4px;
      font-size: 14px;
    }

    .selectedInfo[wide] {
      padding-top: 4px;
      font-size: 20px;
    }

    .noIdeasInfo {
      width: 100%;
      color: #555;
      font-size: 16px;
    }

    .noIdeasInfo[wide] {
      font-size: 24px;
    }

    .ideaInBudget {
      border-left: solid 3px;
      border-left-color: var(--paper-yellow-a700);
    }
  </style>

  <template>
    <iron-media-query query="(min-width: 1000px)" query-matches="{{wide}}"></iron-media-query>
    <div class="budgetContainer" wide$="[[wide]]">
      <paper-material elevation="5" class="budgetMaterial" wide$="[[wide]]">
        <div class="budgetRuler layout horizontal justified" wide$="[[wide]]">
          <div>0[[_millionWord()]]</div>
          <div>12.5[[_millionWord()]]</div>
          <div>25[[_millionWord()]]</div>
        </div>
        <div id="votes" wide$="[[wide]]">
          <div id="noIdeas" class="layout horizontal center-center noIdeasInfo" wide$="[[wide]]" hidden$="[[!noSelectedIdeas]]">
            <div>{{localize('no_ideas_selected')}}</div>
          </div>
        </div>
        <div class="info layout horizontal" wide$="[[wide]]">
          <div class="flex layout vertical">
            <div>Kjóstu þín verkefni í fjárhagsáætlun fyrir Kársnes</div>
            <template is="dom-if" if="[[selectedBudget]]">
              <div class="selectedInfo" wide$="[[wide]]">{{localize("selected_ideas_info", "number_of_ideas", selectedIdeas.length, "selectedBudget", selectedBudget)}}</div>
            </template>
          </div>
          <div class="">
            <paper-button id="votingButton" raised class="voteButton" on-tap="_submitVote">Kjósa!</paper-button>
          </div>
        </div>
      </paper-material>
    </div>
  </template>

</dom-module>

<script>
  (function() {
    Polymer({

      is: 'oav-area-budget',

      behaviors: [
        Polymer.appHelpers,
        Polymer.AppLocalizeBehavior
      ],

      properties: {

        selectedIdeas: {
          type: Array,
          value: [],
          notify: true
        },

        noSelectedIdeas: {
          type: Boolean,
          value: true
        },

        areaName: {
          type: String,
          value: "Kársnes"
        },

        selectedBudget: {
          type: Number,
          value: 0
        },

        totalBudget: {
          type: Number,
          value: 25.0
        },

        votesWidth: {
          type: Number,
          value: 960
        },

        wide: {
          type: Boolean,
          observer: '_wideChanged'
        }
      },

      observers: [
        '_selectedIdeasChanged(selectedIdeas.splices)'
      ],

      attached: function() {
        this.loadResources(this.resolveUrl('../locales.json'));
      },

      _wideChanged: function (isWide) {
        if (isWide) {
          this.set('votesWidth', 960);
        } else {
          this.set('votesWidth', 300);
        }
        this._resetBudgetDiv();
        this.selectedIdeas.forEach(function (idea) {
           this._addIdeaToDiv(idea);
        }.bind(this));
      },

      _millionWord: function () {
        var localizeMethod = this.__computeLocalize(this.language, this.resources, this.formats);
        if (this.wide) {
          return localizeMethod('million');
        } else {
          return localizeMethod('million_short');
        }
      },

      _submitVote: function () {
        this.fire('oav-submit-vote');
      },

      _selectedIdeasChanged: function () {
        if (this.selectedIdeas && this.selectedIdeas.length>0) {
          this.set('noSelectedIdeas', false);
          this.$.votingButton.disabled = false;
        } else {
          this.set('noSelectedIdeas', true);
          this.$.votingButton.disabled = true;
        }
      },

      reset: function () {
        this._resetBudgetDiv();
        this.set('selectedIdeas', []);
        this.set('selectedBudget', 0);
      },

      _resetBudgetDiv: function () {
        while (this.$.votes.lastChild && this.$.votes.lastChild.id!='noIdeas') {
          this.$.votes.removeChild(this.$.votes.lastChild);
        }
      },

      _removeIdeaFromArray: function (idea) {
        var newArray = [];
        this.selectedIdeas.forEach(function (i) {
          if (i.id!=idea.id) {
            newArray.push(i);
          }
        });
        this.set('selectedIdeas', newArray);
      },

      _addIdeaToDiv: function (idea) {
        var ideaWidth = parseInt(this.votesWidth * (idea.price / this.totalBudget))-(1*this.selectedIdeas.length);
        var image = document.createElement("iron-image");
        image.src = idea.imageUrl;
        image.setAttribute("sizing", "cover");
        image.setAttribute('alt', idea.name);
        image.setAttribute('title', idea.name);
        image.addEventListener('tap',this._removeIdea);
        image.title= idea.name;
        image.className = '.ideaInBudget';
        image.style.width = ideaWidth + 'px';
        image.style.cursor = 'pointer';
        image.style.borderLeft = 'solid 2px';
        image.style.borderRight = 'solid 2px';
        image.style.borderColor = '#ffd600';
        image.id = "idea_id_"+idea.id;
        if (this.wide) {
          image.style.height = '100px';
        } else {
          image.style.height = '50px';
        }
        this.$.votes.appendChild(image);
      },

      _removeIdeaFromDiv: function (idea) {
        var selectedIdeaDiv = this.$$("#idea_id_"+idea.id);
        console.log("SELECTED: "+selectedIdeaDiv.id);
        selectedIdeaDiv.parentNode.removeChild(selectedIdeaDiv);
      },

      toggleBudgetIdea: function (idea) {
        if (this.selectedIdeas.indexOf(idea) > -1) {
          this._removeIdeaFromArray(idea);
          this._removeIdeaFromDiv(idea);
          this.set('selectedBudget', this.selectedBudget - idea.price);
          this.fire('oav-idea-de-selected-from-budget', { ideaId: idea.id });
        } else {
          if (this.selectedBudget+idea.price<=this.totalBudget) {
            this.push('selectedIdeas', idea);
            this._addIdeaToDiv(idea);
            this.set('selectedBudget', this.selectedBudget + idea.price);
            this.fire('oav-idea-selected-in-budget', { ideaId: idea.id });
          } else {
            this.fire('oav-error', this.localize('error_does_not_fit_in_budget'));
          }
        }
      },

      _removeIdea: function (event) {
        debugger;
      },

      convertDots: function (num) {
        return num.replace(".", ",");
      }
    })
  })();

</script>

