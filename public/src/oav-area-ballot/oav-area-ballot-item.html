<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-share-button/paper-share-button.html">

<link rel="import" href="../oav-ajax/oav-ajax.html">
<link rel="import" href="oav-area-budget.html">

<dom-module id="oav-area-ballot-item">
  <style>
    .itemContent {
      @apply(--layout-vertical);
      position: relative;
      width: 300px !important;
      height: 320px;
      margin: 16px;
    }

    .itemContent[small] {
      width: 260px !important;
      height: 277px;
      margin: 0;
    }

    .itemContent[small][tiny] {
      width: 220px !important;
      height: 220px;
    }

    .itemSelectedFrame {
      background: transparent;
      border: none;
      width: 296px;
      height: 316px;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 4;
    }

    .itemSelectedFrame[small] {
      width: 254px;
      height: 271px;
    }

    .itemSelectedFrame[small][tiny] {
      width: 214px;
      height: 214px;
    }

    .buttons {
      z-index: 5;
    }

    .itemSelectedFrame[selected] {
      background: transparent;
      border: solid 2px;
      border-color: var(--app-accent-color);
    }

    iron-image {
      height: 169px;
      width: 300px;
    }

    iron-image[small] {
      width: 260px;
      height: 146px;
    }

    iron-image[small][tiny] {
      width: 220px;
      height: 124px;
    }

    google-map {
      height: 169px;
      width: 300px;
      margin-bottom: 7px;
    }

    google-map[small] {
      width: 260px;
      height: 146px;
      z-index: 0 !important;
    }

    google-map[small][tiny] {
      width: 220px;
      height: 124px;
    }

    .descriptionContainer {
      height: 169px;
      width: 300px;
      margin: 0;
      overflow: hidden;
      background-color: var(--paper-blue-700);
      font-size: 18px;
      color: #FFF;
      font-weight: bold;
      text-align: left;
    }

    .descriptionContainer[small] {
      width: 260px;
      height: 146px;
      font-size: 16px;
      text-align: left;
    }

    .descriptionContainer[small][tiny] {
      width: 220px;
      height: 124px;
      font-size: 15px;
    }

    .description {
      padding: 8px;
      font-size: 16px;
      margin-top: 42px;
    }

    .name {
      font-size: 20px;
      padding: 8px;
      color: #222;
    }

    .name[small] {
      font-size: 17px;
      padding-top: 4px;
      padding-right: 4px;
      padding-top: 4px;
    }

    .name[small][tiny] {
      font-size: 14px;
    }

    .price {
      font-size: 25px;
      position: absolute;
      bottom: 8px;
      left: 114px;
      color: var(--app-accent-color);
    }

    .price[small] {
      left: 70px;
    }

    .price[small][tiny] {
      left: 42px;
    }
    
    .priceCurrency {
      font-size: 23px;
      color: var(--app-accent-color);
    }

    paper-fab.addRemoveButton {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background-color: var(--app-accent-color);
      color: #fff;
    }

    paper-fab.removeButton {
      background-color: #fff !important;
      color: var(--app-accent-color) !important;
    }

    paper-fab.addFavoriteButton {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background-color: var(--app-accent-color);
      color: #FFF;
      --paper-fab-iron-icon: {
        height: 29px;
        width: 29px;
      };
      padding: 0;
      padding-top: 3px;
    }

    .shareIcon {
      position: absolute;
      top: 6px;
      left: 0;
      --paper-share-button-icon-color: var(--app-accent-color-light);
      --paper-share-button-icon-height: 46px;
      --paper-share-button-icon-width: 46px;
      -webkit-filter: drop-shadow( 1px 1px 10px #555 );
      filter: drop-shadow( 1px 1px 10px #555 );
    }

    .shareIcon[small] {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 2px;
    }

    paper-fab.removeFavoriteButton {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background-color: #FFF;
      color: var(--paper-red-a700);
      --paper-fab-iron-icon: {
        height: 29px;
        width: 29px;
      };
      padding: 0;
      padding-top: 3px;
    }

    paper-fab[disabled] {
      background-color: #b7b7b7;
    }

    .budgetContainer {
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
    }

    .itemContent {
      background-color: #fbfbfb;
      color: #222;
    }

    .addRemoveButton {

    }

    .infoIcon {
      color: var(--app-accent-color-light);
      width: 32px;
      height: 32px;
      padding: 0;
      margin-right: 4px;
    }

    .infoLinks {
      position: absolute;
      top: 118px;
      right: 0px;
      z-index: 2;
    }

    .stateDropdown {
      color: var(--app-accent-color-light);
      position: absolute;
      top: 60px;
      right: 0;
      z-index: 2;
      padding-right: 0;
      margin-right: 0;
    }

    .dropdownMenuButton {
      position: absolute;
      top: 8px;
      right: 8px;
    }

    .dropdownButton {
      background-color: var(--app-accent-color);
      opacity: 0.8;
      color: #fff;
      padding: 2px;
      width: 32px;
      height: 26px;
    }

    .infoLinks[small] {
      top: 98px;
    }

    .infoLinks[small][tiny] {
      top: 78px;
    }

    .externalInfoIcon {
      color: #999;
      width: 45px;
      height: 45px;
    }

    .externalIconContainer {
      position: absolute;
      bottom: 4px;
      left: 0px;
      z-index: 2;
    }

    google-map {
      z-index: 5;
    }

    paper-fab {
      z-index: 5;
    }

    .favoriteButtons {
    }


  </style>

  <template>
    <iron-signals on-iron-signal-set-language="setLanguage"></iron-signals>
    <iron-media-query query="(max-width: 360px)" query-matches="{{tiny}}"></iron-media-query>

    <paper-material animated elevation="[[elevation]]" class="itemContent" small$="[[small]]" tiny$="[[tiny]]">
      <iron-image preload on-loaded-changed="_imageLoadedChanged" small$="[[small]]" tiny$="[[tiny]]" hidden$="[[!imageTabSelected]]" name="image" sizing="cover" src="[[item.image_url]]"></iron-image>
      <template is="dom-if" if="[[mapTabSelected]]" restamp>
        <template is="dom-if" if="[[mapsHeight]]" restamp>
          <iron-image class="main-image" sizing="cover"
                      src$="https://maps.googleapis.com/maps/api/staticmap?center=[[latitude]],[[longitude]]&zoom=15&size=[[mapsWidth]]x[[mapsHeight]]&markers=color:red%7Clabel:%7C[[latitude]],[[longitude]]&key=[[staticMapsApiKey]]"
                      hidden$="[[!mapTabSelected]]"></iron-image>
        </template>
      </template>
      <div hidden$="[[!descriptionTabSelected]]" name="description" class="descriptionContainer" tiny$="[[tiny]]" small$="[[small]]" tiny$="[[tiny]]">
        <div id="description" class="description">
          [[item.description]]
        </div>
      </div>
      <paper-menu-button on-tap="_openMenu" small$="[[small]]" tiny$="[[tiny]]" class="dropdownMenuButton" horizontal-align="right">
        <paper-icon-button title$="{{localize('more_information')}}" class="dropdown-trigger dropdownButton" no-tap="_clickedDropDownMenu" title$="{{localize('select')}}" icon="menu"></paper-icon-button>
        <paper-menu class="dropdown-content">
          <paper-item on-tap="_setImageMode">
            <iron-icon title$="{{localize('image_item_tab')}}" class="infoIcon" icon="image:photo"></iron-icon>{{localize('image_item_tab')}}
          </paper-item>
          <paper-item on-tap="_setDescriptionMode">
            <iron-icon title$="{{localize('description_item_tab')}}" class="infoIcon" icon="description"></iron-icon>{{localize('description_item_tab')}}
          </paper-item>
          <paper-item on-tap="_setMapMode">
            <iron-icon title$="{{localize('map_item_tab')}}" class="infoIcon" icon="maps:place"></iron-icon>{{localize('map_item_tab')}}
          </paper-item>
          <paper-item on-tap="_showPost">
            <iron-icon raised title$="{{localize('more_info_description')}}" class="infoIcon" icon="info"></iron-icon>{{localize('more_info_description')}}
          </paper-item>
        </paper-menu>
      </paper-menu-button>
      <div class="layout horizontal">
        <div class="name" small$="[[small]]" tiny$="[[tiny]]">[[item.name]]</div>
      </div>
      <div class="buttons">
        <paper-share-button hidden$="[[!imageLoaded]]" small$="[[small]]" on-share-tap="_shareTap" class="shareIcon" horizontal-align="left" id="shareButton" title$="{{localize('share_idea')}}" facebook twitter popup url$="[[itemShareUrl]]"></paper-share-button>

        <div class="price" small$="[[small]]" tiny$="[[tiny]]">&pound[[formatNumber(item.price)]]
          <span class="priceCurrency" hidden$="[[!_priceIsOne(item.price)]]">{{localize('million')}}</span>
          <span class="priceCurrency" hidden$="[[_priceIsOne(item.price)]]">{{localize('millions')}}</span>
        </div>
        <paper-fab mini id="addToBudgetButton" elevation="5" class="addRemoveButton" hidden$="[[selectedInBudget]]"
                   disabled$="[[toExpensiveForBudget]]" title$="{{localize('add_to_budget')}}" icon="add" on-tap="_toggleInBudget">
        </paper-fab>
        <paper-fab mini elevation="5" class="addRemoveButton removeButton" hidden$="[[!selectedInBudget]]"
                   disabled$="[[toExpensiveForBudget]]" title$="{{localize('remove_from_budget')}}" icon="remove" on-tap="_toggleInBudget">
        </paper-fab>
        <div id="favoriteButtons" class="favoriteButtons" hidden$="[[!selectedInBudget]]">
          <paper-fab mini id="addFavoriteButton" class="addFavoriteButton" elevation="5" class="favoriteButton" hidden$="[[isFavorite]]"
                     title$="{{localize('select_favorite')}}" icon="favorite-border" on-tap="_toggleFavorite">
          </paper-fab>
          <paper-fab mini class="removeFavoriteButton" elevation="5" class="favoriteButton" hidden$="[[!isFavorite]]"
                     title$="{{localize('deselect_favorite')}}" icon="favorite" on-tap="_toggleFavorite">
          </paper-fab>
        </div>
      </div>
    </paper-material>
  </template>
</dom-module>

<script>
  (function() {
    Polymer({

      is: 'oav-area-ballot-item',

      behaviors: [
        Polymer.appHelpers,
        Polymer.AppLocalizeBehavior
      ],

      properties: {
        item: {
          type: Object,
          observer: '_itemChanged'
        },

        staticMapsApiKey: {
          type: String,
          value: "AIzaSyBYy8UvdDD650mz7k1pY0j2hBFQmCPVnxA"
        },

        elevation: Number,

        budgetElement: {
          type: Object
        },

        selectedInBudget: {
          type: Boolean,
          value: false,
          observer: 'selectedInBudgetChanged'
        },

        toExpensiveForBudget: {
          type: Boolean,
          value: false
        },

        isFavorite: {
          type: Boolean,
          value: false
        },

        googleMapsApiKey: {
          type: String,
          value: "AIzaSyDkF_kak8BVZA5zfp5R4xRnrX8HP3hjiL0"
        },

        imageTabSelected: {
          type: Boolean,
          value: true
        },

        descriptionTabSelected: {
          type: Boolean,
          value: false
        },

        mapTabSelected: {
          type: Boolean,
          value: false
        },

        descriptionPdfLink: {
          type: String,
          computed: '_descriptionPdfLink(item)'
        },

        itemShareUrl: {
          type: String,
          computed: '_itemShareUrl(item)'
        },

        small: {
          type: Boolean,
          value: false,
          observer: '_smallChanged'
        },

        tiny: {
          type: Boolean,
          value: false,
          observer: '_tinyChanged'
        },

        mapsHeight: {
          type: String,
          value: null
        },

        mapsWidth: {
          type: String,
          value: null
        },

        longitude: {
          type: String,
          value: null
        },

        latitude: {
          type: String,
          value: null
        },

        imageLoaded: {
          type: Boolean,
          value: false
        }
      },

      _imageLoadedChanged: function (event, detail) {
        if (detail.value) {
          this.set('imageLoaded', true);
        }
      },

      _smallChanged: function (small) {
        if (small) {
          this.set('mapsHeight', '260');
          this.set('mapsWidth', '146');
        } else {
          this.set('mapsHeight', '169');
          this.set('mapsWidth', '300');
        }
      },

      _tinyChanged: function (tiny) {
        if (tiny) {
          this.set('mapsHeight', '220');
          this.set('mapsWidth', '124');
        } else {
          this.set('mapsHeight', '169');
          this.set('mapsWidth', '300');
        }
      },

      selectedInBudgetChanged: function (newValue, oldValue) {
        if (newValue===true) {
          this.set('elevation', "4");
        } else {
          this.set('elevation', "1");
        }
      },

      _toggleFavorite: function () {
        if (this.budgetElement.currentBallot.favoriteItem &&
          this.budgetElement.currentBallot.favoriteItem.id == this.item.id) {
          this.fire('oav-set-favorite-item-in-budget', {
            item: null
          });
        } else {
          var button = this.$$("#addFavoriteButton");
          var buttonRect = button.getBoundingClientRect();
          var left = buttonRect.left;// + window.scrollX;
          var top = buttonRect.top;// + window.scrollY;
          this.fire('oav-set-favorite-item-in-budget', {
            item: this.item,
            orgAnimPos: { left: left, top: top },
            budgetAnimPos: this.budgetElement.getItemLeftTop(this.item)
          });
        }
      },

      _clickedDropDownMenu: function () {
        window.appGlobals.activity('click', 'dropdown');
      },

      _priceIsOne: function (price) {
        if (price && price<=1.0) {
          return true;
        } else {
          return false;
        }
      },

      _openPdf: function () {
        window.appGlobals.activity('click', 'openPdf');
        window.open(this.item.pdf_url, '_blank');
      },

      _showPost: function () {
        window.appGlobals.activity('click', 'showPost');
        window.appLastArea = '/'+window.location.hash;
        window.location = "/#/post/"+this.item.idea_id;
      },

      _descriptionPdfLink: function (newItem) {
        if (newItem && window.appGlobals && window.appGlobals.configFromServer && window.appGlobals.configFromServer.ideas_without_pdfs) {
          var ideasWithOutPdfs = JSON.parse(window.appGlobals.configFromServer.ideas_without_pdfs);
          if (!ideasWithOutPdfs || ideasWithOutPdfs.indexOf(parseInt(newItem.idea_id)) > -1) {
            return null;
          } else {
            return 'https://s3-eu-west-1.amazonaws.com/oav-direct-assets/hverfid_mitt_2016/moreProjectInformation_'+newItem.idea_id+'.pdf';
          }
        } else {
          return null;
        }
      },

      _itemShareUrl: function (newItem) {
        if (newItem) {
          return encodeURIComponent("https://"+window.location.host+"/items/"+newItem.id);
        } else {
          return null;
        }
      },

      _shareTap: function (event, detail) {
        window.appGlobals.activity('click', 'shareItem');
      },

      _itemChanged: function (newItem) {
        if (newItem) {
          if (newItem.locations && newItem.locations.length>0) {
            this.set('longitude', newItem.locations[0].longitude);
            this.set('latitude', newItem.locations[0].latitude);
          }
          this.resetFromBudget();
        }
      },

      resetFromBudget: function () {
        //console.log("resetFromBudget itemId: "+this.item.id);
        if (this.budgetElement) {
          if (this.budgetElement.selectedItems.indexOf(this.item) > -1) {
            this.setInBudget();
            this.setNotTooExpensive();
            if (this.budgetElement.currentBallot.favoriteItem==this.item) {
              this.set('isFavorite', true);
            } else {
              this.set('isFavorite', false);
            }
          } else {
            var budgetLeft = this.budgetElement.totalBudget-this.budgetElement.selectedBudget;
            if (this.item.price>budgetLeft) {
              this.setTooExpensive()
            } else {
              this.setNotTooExpensive()
            }
            this.removeFromBudget();
          }
        }
        this._setImageMode(true);
      },

      _setImageMode: function (disableActivity) {
        if (!disableActivity || disableActivity===false) {
          window.appGlobals.activity('select', 'imageMode');
        }
        this.set('imageTabSelected', true);
        this.set('descriptionTabSelected', false);
        this.set('mapTabSelected', false);
      },

      _setMapMode: function () {
        window.appGlobals.activity('select', 'mapMode');
        this.set('imageTabSelected', false);
        this.set('descriptionTabSelected', false);
        this.set('mapTabSelected', true);
      },

      _setDescriptionMode: function () {
        window.appGlobals.activity('select', 'descriptionMode');
        this.set('imageTabSelected', false);
        this.set('descriptionTabSelected', true);
        this.set('mapTabSelected', false);
      },

      _toggleDescription: function () {
        window.appGlobals.activity('toggle', 'description');
        if (this.descriptionTabSelected===true) {
          this._setImageMode();
        } else {
          this._setDescriptionMode();
        }
      },

      _openMenu: function () {
        window.appGlobals.activity('open', 'itemMenu');
      },

      setInBudget: function () {
        //console.log("setInBudget itemId: "+this.item.id);
        this.set('selectedInBudget', true);
      },

      removeFromBudget: function () {
        //console.log("removeFromBudget itemId: "+this.item.id);
        this.set('selectedInBudget', false);
        this.set('isFavorite', false);
      },

      setTooExpensive: function () {
        //console.log("setTooExpensive itemId: "+this.item.id);
        this.set('toExpensiveForBudget', true);
      },

      setNotTooExpensive: function () {
        //console.log("setNotTooExpensive itemId: "+this.item.id);
        this.set('toExpensiveForBudget', false);
      },

      attached: function() {
        this.loadLanguage(this.resolveUrl('/src/locales.json'));
      },

      _toggleInBudget: function (event) {
        //console.log("_toggleInBudget itemId: "+this.item.id);
        this.fire('oav-toggle-item-in-budget', { item: this.item });
      }
    })
  })();

</script>

