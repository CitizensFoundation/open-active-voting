<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer-ts/polymer-ts.html">
<link rel="import" href="../../bower_components/paper-map-info/paper-map-info.html">

<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/google-map/google-map-marker.html">

<link rel="import" href="../oav-behaviors/app-helpers.html">

<dom-module id="oav-items-map">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
        width: 100% !important;
        height: 100% !important;
      }

      .topMapContainer {
        width: 100% !important;
        height: 100% !important;
      }

      .mapContainer {
        width: 100% !important;
        height: 100% !important;
        margin-top: 24px;
      }

      .noMapContainer {
        padding: 8px;
        margin: 24px;
        background-color: #FFF;
      }

      #map {
      }

      a {
        color: var(--primary-color-700);
      }

      h1 {
        padding: 24px;
      }


      #myInfoCard {
        background-color: #000;
        padding: 0;
        margin: 0 !important;
        --paper-map-info-mixin: {
          padding: 0;
          margin: 0 !important;
          background-color:rgba(255, 255, 255, 0.7);
          color: #000;
          max-width: 100%;
          max-height: 100%;
        };
        --paper-map-info-beak-mixin: {
          color: var(--app-accent-color);
        };
      }

      .ballotItem {
        margin: 0;
        padding: 0;
        color: #FFF;
      }
    </style>

    <iron-media-query query="(min-width: 1000px)" query-matches="{{wide}}"></iron-media-query>

    <div class="layout vertical center-center topMapContainer">
      <template is="dom-if" if="[[noItems]]">
        <paper-material elevation="3" class="noMapContainer">
          <h1>[[t('items.noMapItems')]]</h1>
        </paper-material>
      </template>

      <template is="dom-if" if="[[items]]" restamp>
        <div class="mapContainer">
          <google-map id="map" api-key="[[apiKey]]" fit-to-markers>
            <template is="dom-repeat" items="[[items]]" as="item">
              <google-map-marker click-events latitude="[[item.location.latitude]]" longitude="[[item.location.longitude]]" class="marker" on-google-map-marker-click="markerClick">
              </google-map-marker>
            </template>
            <paper-map-info id="myInfoCard" fade-in>
              <oav-area-ballot-item elevation="0" id="ballotItem" budget-element="[[budgetElement]]" class="ballotItem" item="[[selectedItem]]"></oav-area-ballot-item>
            </paper-map-info>
          </google-map>
        </div>
      </template>

    </div>
  </template>

  <script>
    Polymer({
      is: 'oav-items-map',

      behaviors: [
        Polymer.appHelpers,
        Polymer.AppLocalizeBehavior
      ],

      properties: {
        items: {
          type: Array,
          value: null,
          observer: '_itemsChanged'
        },

        budgetElement: {
          type: Object
        },

        selectedItem: {
          type: Object
        },

        noItems: {
          type: Boolean,
          value: false
        },

        apiKey: {
          type: String,
          value: "AIzaSyDkF_kak8BVZA5zfp5R4xRnrX8HP3hjiL0"
        },

        wide: {
          type: Boolean,
          observer: '_wideChanged'
        }
      },

      _itemsChanged: function () {

      },

      attached: function () {
        this.async(function () {
          this._resetMapHeight();
        }.bind(this));
      },

      _wideChanged: function () {
        this._resetMapHeight();
      },

      _resetMapHeight: function () {
        var map = this.$$("#map");
        if (map) {
          var height;
          if (this.wide) {
            height = window.innerHeight - 342;
          } else {
            height = window.innerHeight - 242;
          }
          map.style.height = height + 'px';
        }
      },

      setItemInBudget: function (item) {
        if (this.selectedItem && this.selectedItem.id == item.id) {
          var item = this.$$("#ballotItem");
          if (item) {
            item.setInBudget();
          }
        }
      },

      removeFromBudget: function (item) {
        if (this.selectedItem && this.selectedItem.id == item.id) {
          var item = this.$$("#ballotItem");
          if (item) {
            this.$$("#ballotItem").removeFromBudget();
          }
        }
      },

      checkIfSelectedItemToExpensive: function(budgetLeft) {
        if (this.selectedItem) {
          var item = this.$$("#ballotItem");
          if (item) {
            if (!item.selectedInBudget) {
              if (this.selectedItem.price<=budgetLeft) {
                item.setNotTooExpensive();
                console.log("item id "+this.selectedItem.id+ "Not Too Expensive");
              } else if (this.selectedItem) {
                console.log("item id "+this.selectedItem.id+ "Too Expensive");
                item.setTooExpensive();
              }
            }
          }
        }
      },

      markerClick: function(e) {
        this.set('selectedItem', e.model.get('item'));
        this.$$("#myInfoCard").showInfoWindow(e.srcElement.marker);
      }
    });
  </script>
</dom-module>