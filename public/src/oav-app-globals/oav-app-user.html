<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../oav-behaviors/app-helpers.html">
<link rel="import" href="../oav-session/oav-session.html">
<link rel="import" href="../oav-user/oav-login.html">
<link rel="import" href="../oav-ajax/oav-ajax.html">

<dom-module id="oav-app-user">
  <template>
    <style>
      paper-toast {
        z-index: 9999;
      }
    </style>

    <oav-session id="session"></oav-session>

    <div class="layout horizontal center-center">
      <oav-ajax id="isLoggedInAjax" method="GET" url="/api/users/loggedInUser/isloggedin" on-response="_isLoggedInResponse"></oav-ajax>
      <oav-ajax id="logoutAjax" method="POST" url="/api/users/logout" on-response="_logoutResponse"></oav-ajax>
    </div>

    <paper-toast id="loginToast" text="[[toastLoginTextCombined]]"></paper-toast>
    <paper-toast id="logoutToast" text="[[toastLogoutTextCombined]]"></paper-toast>
  </template>

  <script>
    (function () {
      Polymer({

        is: 'oav-app-user',

        behaviors: [
          Polymer.appHelpers
        ],

        properties: {

          toastLoginTextCombined: {
            type: String
          },

          toastLogoutTextCombined: {
            type: String
          },

          user: {
            type: Object,
            observer: "_onUserChanged"
          },

          pointQualitiesIndex: {
            type: Object
          },

          completeExternalLoginText: {
            type: String,
            value: null
          }
        },

        openUserlogin: function () {
          var dialog = Polymer.dom(document).querySelector('yp-app').getDialog("userLogin");
          dialog.setup(this._handleLogin.bind(this));
          dialog.open();
        },

        _closeUserLogin: function () {
          var dialog = Polymer.dom(document).querySelector('yp-app').getDialog("userLogin");
          dialog.close();
        },

        _setUserLoginSpinner: function () {
          var dialog = Polymer.dom(document).querySelector('yp-app').getDialog("userLogin");
          dialog.setUserSpinner(true);
        },

        _handleLogin: function (user) {
          this._closeUserLogin();
          this.setLoggedInUser(user);
          this.toastLoginTextCombined = this.t("user.loginCompleteFor")+ " " + this.user.name;
          this.$.loginToast.show();
          this.fire("login");
        },

        getUser: function () {
          return this.$.session.get('user');
        },

        setLoggedInUser: function (user) {
          this.$.session.set('user', user);
          this.user = user;
          this.fire('iron-signal', {name: 'logged-in', data:  user });
        },

        removeUserSession: function () {
          this.$.session.unset('user');
          this.user = null;
        },

        loggedIn: function () {
          return this.$.session.has('user');
        },

        logout: function () {
          this.$.logoutAjax.body = {};
          this.$.logoutAjax.generateRequest();
        },

        ready: function () {
          window.appUser = this;
          this.checkLogin();

        },

        loginFromSaml: function () {
          this._completeExternalLogin(this.t('user.loggedInWithSaml'));
        },

        _completeExternalLogin: function (fromString) {
          this.checkLogin();
          this._setUserLoginSpinner();
          this.set('completeExternalLoginText', fromString);
        },

        checkLogin: function () {
          this.$.isLoggedInAjax.url = "/api/users/loggedInUser/isloggedin" + "?" + (new Date()).getTime();
          this.$.isLoggedInAjax.generateRequest();
        },

        _onUserChanged: function (newValue, oldValue) {
          this.fire("user-changed", newValue);
          if (newValue) {
            this._updateEndorsementPostsIndex(newValue);
            this._updatePointQualitiesIndex(newValue);
            this.fire('iron-signal', {name: 'got-endorsements-and-qualities'});
          }
        },

        _logoutResponse: function (event, detail) {
          this.toastLogoutTextCombined = this.t("user.logoutCompleteFor")+ " " + this.user.name;
          this.removeUserSession();
          this.$.logoutToast.show();
          this.async(function() {
            location.reload();
          },1200);
        },

        _isLoggedInResponse: function(event, detail) {
          if (detail.response===0) {
            this.removeUserSession();
          } else if (detail.response.name) {
            this.setLoggedInUser(detail.response);
          }
          if (detail.response.missingEmail) {
            var dialog = Polymer.dom(document).querySelector('yp-app').getDialog("missingEmail");
            dialog.open(detail.response.loginProvider);
          }

          if (this.completeExternalLoginText) {
            window.appGlobals.notifyUserViaToast(this.completeExternalLoginText);
            this._closeUserLogin();
            this.set('completeExternalLoginText', null);
          }
        }
      });
    }());
  </script>
</dom-module>
